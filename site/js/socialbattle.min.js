var app=angular.module("socialBattle",["angular-loading-bar","ui.router","states","restangular","facebook","ngStorage","ui.bootstrap","doowb.angular-pusher","services","directives","auth","user","room","post","search","character"]);app.run(["$rootScope","$state","$stateParams","CheckAuthService","IdentityService","RefreshTokenService","Restangular","$localStorage",function(a,b,c,d,e,f,g,h){f.init(),a.$on("$stateChangeStart",function(b,c,e){a.toState=c,a.toStateParams=e,d.check_auth()}),g.setDefaultHeaders({Authorization:"Bearer "+h.access_token})}]),app.config(["RestangularProvider",function(a){a.setBaseUrl("http://localhost.socialbattle:8000/"),a.setRequestSuffix("/")}]),app.config(["FacebookProvider",function(a){a.init("1451410555106201")}]),app.config(["$urlRouterProvider",function(a){a.otherwise("/")}]),app.config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),app.config(["PusherServiceProvider",function(a){a.setToken("3863968fa562d8ec8569").setOptions({})}]),app.constant("CLIENT_ID","hHH7dFdb=KpR0gpJVSiEO6rKArllw9e@=w=-?Gl1"),app.constant("API_URL","http://localhost.socialbattle:8000/"),angular.module("states",[]).config(["$stateProvider",function(a){a.state("unlogged",{url:"/",templateUrl:"html/home.html",controller:"Auth",onEnter:["IdentityService","$state",function(a,b){a.identity().then(function(a){b.go("user",{username:a.username})})}]}).state("logged",{templateUrl:"html/layout.html","abstract":!0,controller:"Logged",resolve:{authorize:["CheckAuthService",function(a){return a.check_auth()}],user:["IdentityService",function(a){return a.identity().then(function(a){return a})}]}}).state("user",{parent:"logged",url:"/users/:username",templateUrl:"html/partials/user.html",controller:"UserDetail"}).state("user.following",{url:"/following",templateUrl:"html/partials/user.followx.html",controller:"UserFollowing"}).state("user.followers",{url:"/followers",templateUrl:"html/partials/user.followx.html",controller:"UserFollowers"}).state("user.posts",{url:"/posts",templateUrl:"html/partials/posts.html",controller:"UserPosts",resolve:{character:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).get().then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],inventory:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("inventory").then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}]}}).state("user.characters",{url:"/characters",templateUrl:"html/partials/user.characters.html",controller:"UserCharacters"}).state("pveroom",{parent:"logged",url:"/rooms/pve/:room_name",templateUrl:"html/partials/pveroom.html",resolve:{character:["$localStorage","Restangular","$modal",function(a,b){return b.one("characters",a.character.name).get().then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],character_abilities:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("abilities").then(function(a){var c=b.stripRestangular(a);return c})}],weapons:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("weapons").then(function(a){var c=b.stripRestangular(a);return c})}],armors:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("armors").then(function(a){var c=b.stripRestangular(a);return c})}],items:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("items").then(function(a){var c=b.stripRestangular(a);return c})}],mobs:["$stateParams","Restangular",function(a,b){return b.one("rooms/pve",a.room_name).getList("mobs").then(function(a){var c=b.stripRestangular(a);return c})}],room:["$stateParams","Restangular",function(a,b){return b.one("rooms/pve",a.room_name).get().then(function(a){var c=b.stripRestangular(a);return c})}]},controller:"PVERoom"}).state("relaxroom",{parent:"logged",url:"/rooms/relax/:room_name",templateUrl:"html/partials/relaxroom.html",controller:"RelaxRoom",resolve:{character:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).get().then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],room:["$stateParams","Restangular",function(a,b){return b.one("rooms/relax",a.room_name).get().then(function(a){var c=b.stripRestangular(a);return c})}],inventory:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("inventory").then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],buy_items:["$stateParams","Restangular",function(a,b){return b.one("rooms/relax",a.room_name).getList("items").then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}]}}).state("relaxroom.posts",{url:"/posts",templateUrl:"html/partials/posts.html",controller:"RelaxRoomPosts"}).state("character",{parent:"logged",url:"/characters/:name",templateUrl:"html/partials/character.html",controller:"CharacterDetail"}).state("character.abilities",{url:"/abilities",templateUrl:"html/partials/character.abilities.html",controller:"CharacterAbilities"}).state("character.inventory",{url:"/inventory",templateUrl:"html/partials/character.inventory.html",controller:"CharacterInventory"}).state("post",{parent:"logged",url:"/posts/:id/",resolve:{character:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).get().then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],inventory:["$localStorage","Restangular",function(a,b){return b.one("characters",a.character.name).getList("inventory").then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}],post:["$stateParams","Restangular",function(a,b){return b.one("posts",a.id).get().then(function(a){var c=b.stripRestangular(a);return c},function(a){console.log(a)})}]},controller:["$scope","character","inventory","post",function(a,b,c,d){a.character=b,a.inventory=c,a.post=d}],template:'<post post="post" ng-controller="Post"/>'})}]),angular.module("services",["socialBattle"]).factory("SpawnService",["$q","$timeout","Restangular",function(a,b){var c,d,e={},f=[5,10].map(function(a){return 1e3*a});return e.spawn=function(e){if(0===e.length)return{};d=a.defer();var g=e[Math.floor(Math.random()*e.length)],h=JSON.parse(JSON.stringify(g)),i=Math.floor(f[0]+Math.random()*(f[1]-f[0]));return c=b(function(){h.max_hp=h.hp,h.curr_hp=h.hp,delete h.hp,d.resolve(h)},i,!0),d.promise},e.stop=function(){c&&(b.cancel(c),d.reject("Stopped"))},e}]).factory("AttackService",["$q","$timeout","Restangular",function(a,b){var c={};return c.attack=function(c,d,e){var f=a.defer(),g={attacked:d,ability:e.url};return d||delete g.attacked,c.post(g).then(function(c){var d=a.defer(),g=1e3*c.ct,h=c.dmg;b(function(){d.resolve({ability:e,attacked_hp:c.attacked_hp,attacker_mp:c.attacker_mp,dmg:h})},g,!0),f.resolve({ct:g,attack:d.promise})}),f.promise},c}]).factory("MobService",["Restangular","AttackService",function(a,b){var c={};return c.attack=function(c,d,e){var f=e[Math.floor(Math.random()*e.length)],g=d;"H"==f.element&&(g=void 0);var h=a.one("mobs",c).all("use_ability");return b.attack(h,g,f)},c}]).factory("CharacterService",["Restangular","AttackService",function(a,b){var c={};return c.attack=function(c,d,e){var f=a.one("characters",c.name).all("use_ability"),g=d;return c.url==d&&(g=void 0),b.attack(f,g,e)},c.use_item=function(b,c){var d={item:c.url};return a.one("characters",b).all("use_item").post(d)},c}]).factory("FBStoriesService",["Facebook","$localStorage",function(a,b){var c={};return c.APP_NAMESPACE="socialbattle_test",c.defeat=function(d,e,f){if(b.facebook){var g={character:d,room:e,mob:f};a.api("me/"+c.APP_NAMESPACE+":defeat","post",g,function(a){a.error?console.log(a.error):console.info("Story added to activity log")})}},c.lose=function(d,e,f){if(b.facebook){var g={character:d,room:e,mob:f};a.api("me/"+c.APP_NAMESPACE+":lose_against","post",g,function(a){a.error?console.log(a.error):console.info("Story added to activity log")})}},c.buy=function(d,e,f){if(b.facebook){var g={character:d,room:e,loot:f};a.api("me/"+c.APP_NAMESPACE+":buy","post",g,function(a){a.error?console.log(a.error):console.info("Story added to activity log")})}},c.sell=function(d,e,f){if(b.facebook){var g={character:d,room:e,loot:f};a.api("me/"+c.APP_NAMESPACE+":buy","post",g,function(a){a.error?console.log(a.error):console.info("Story added to activity log")})}},c}]).factory("IdentityService",["$q","$http","$timeout","Restangular","$localStorage",function(a,b,c,d,e){var f=void 0,g=!1,h={};return h.isIdentityResolved=function(){return angular.isDefined(f)},h.isAuthenticated=function(){return g},h.authenticate=function(a){f=a,g=angular.isDefined(a),a?e.user=a:delete e.user},h.identity=function(b){var c=a.defer();return b===!0&&(f=void 0),angular.isDefined(f)?(c.resolve(f),c.promise):(d.one("me").get().then(function(a){var b=d.stripRestangular(a);f=b,g=!0,c.resolve(f)},function(){f=void 0,g=!1,c.reject(f)}),c.promise)},h}]).factory("CheckAuthService",["$rootScope","$state","IdentityService","RefreshTokenService",function(a,b,c,d){var e={};return e.check_auth=function(){return c.identity().then(function(){},function(){d.refreshing||b.go("unlogged")})},e}]).factory("LoginService",["Facebook","$localStorage","Restangular","$q","$state","CLIENT_ID","IdentityService",function(a,b,c,d,e,f,g){var h={},i=function(a){c.setDefaultHeaders({Authorization:"Bearer "+a})};return h.sb_login=function(a,e){var h=d.defer(),j={grant_type:"password",client_id:f,username:a,password:e};return j=$.param(j),c.all("oauth/token").post(j,void 0,{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}).then(function(a){console.log(a),b.refresh_token=a.refresh_token,b.access_token=a.access_token,i(a.access_token),g.identity(!0).then(function(a){g.authenticate(a),h.resolve(a)},function(a){h.reject(a)})},function(a){console.log(a),h.reject(a)}),h.promise},h.fb_login=function(){var e=d.defer(),h=function(a){var d={grant_type:"password",client_id:f,username:"invalid username",password:"password",fb_token:a.authResponse.accessToken};d=$.param(d),c.all("oauth/token").post(d,void 0,{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}).then(function(a){b.facebook=!0,b.refresh_token=a.refresh_token,b.access_token=a.access_token,i(a.access_token),g.identity(!0).then(function(a){g.authenticate(a),e.resolve(a)},function(a){e.reject(a)})},function(a){e.reject(a)})};return a.getLoginStatus(function(b){"connected"==b.status?(console.log("fb connected"),h(b)):"not_authorized"===b.status?e.reject(b.status):a.login(function(a){a.authResponse&&h(a)},{scope:"publish_actions"})}),e.promise},h}]).factory("RefreshTokenService",["$localStorage","Restangular","$q","$http","CLIENT_ID",function(a,b,c,d,e){var f,g={},h=!1,i=function(a){b.setDefaultHeaders({Authorization:"Bearer "+a})},j=function(){if(!a.refresh_token)return f=c.defer(),f.reject("No refresh token"),f.promise;if(h)return f.promise;h=!0,f=c.defer();var d={grant_type:"refresh_token",client_id:e,refresh_token:a.refresh_token};return console.info("Token expired. Refreshing..."),d=$.param(d),b.all("oauth/token").post(d,void 0,{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}).then(function(b){a.refresh_token=b.refresh_token,a.access_token=b.access_token,i(b.access_token),h=!1,f.resolve("Refreshed")},function(a){console.log(a),f.reject("Error")}),f.promise};return g.refreshing=h,g.init=function(){b.setErrorInterceptor(function(a,c,e){return 401===a.status?(j().then(function(f){console.info(f),a.config.headers=b.defaultHeaders,d(a.config).then(e,c.reject)}),!1):!0})},g}]),angular.module("directives",[]).directive("post",function(){return{templateUrl:"html/templates/post.html",scope:!0}}).directive("twitter",function(){return{template:"<h1>CIAO BOMBER</h1>",scope:!0}}),angular.module("auth",["restangular","ngStorage","facebook"]).controller("Auth",["$scope","Restangular","$localStorage","Facebook","$state","LoginService",function(a,b,c,d,e,f){a.$storage=c,a.alerts=[],a.signinForm={},a.signupForm={},a.fb_login=function(){f.fb_login().then(function(a){e.go("user",{username:a.username})},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.sb_login=function(){f.sb_login(a.signinForm.username,a.signinForm.password).then(function(a){e.go("user",{username:a.username})},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.signup=function(){var c={username:a.signupForm.username,email:a.signupForm.email,password:a.signupForm.password},d=a.signupForm.check_password;return d!=c.password?(a.alerts.push({type:"danger",msg:"The two passwords are different!"}),a.signupForm.password="",void(a.signupForm.check_password="")):void b.all("signup").post(c).then(function(){a.alerts.push({type:"success",msg:"Succesfully signed up!"}),a.signupForm={}},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.closeAlert=function(b){a.alerts.splice(b,1)}}]).controller("Logged",["$scope","$stateParams","Restangular","$state","$localStorage","$modal","user","IdentityService","$http","Facebook","API_URL","Pusher",function(a,b,c,d,e,f,g,h,i,j,k,l){if(a.$storage=e,a.username=g.username,a.facebook=e.facebook,a.devcenter_url=k+"oauth/applications/",a.notifications=[],l.subscribe(g.username,"fellow",function(b){a.notifications.push(b)}),!e.character){var m=f.open({templateUrl:"selectCharacterModal.html",controller:"SelectCharacterModal",backdrop:"static",keyboard:!1,resolve:{characters:function(){return c.one("users",g.username).getList("characters").$object},endpoint:function(){return c.one("users",g.username).all("characters")}}});m.result.then(function(a){e.character=a})}a.logout=function(){h.authenticate(void 0),c.setDefaultHeaders({Authorization:""}),delete e.access_token,delete e.refresh_token,delete e.user,delete e.character,delete e.facebook,d.go("unlogged")},a.ass_facebook=function(){console.log("getLoginStatus"),j.getLoginStatus(function(b){a.$apply(function(){if("connected"==b.status){console.log("fb connected");var d={access_token:b.authResponse.accessToken};c.all("sa/associate/").customGET("facebook",d).then(function(a){e.user=a.username,e.facebook=!0},function(a){console.log(a)})}else"not_authorized"===b.status?console.log(b):j.login(function(b){b.authResponse&&a.ass_facebook()},{scope:"publish_actions"})})})}}]).controller("SelectCharacterModal",["$scope","$modalInstance","$localStorage","characters","endpoint","Restangular",function(a,b,c,d,e,f){a.characters=d,a.characterForm={},a.alerts=[],a.create_character=function(){e.post(a.characterForm).then(function(b){a.select(f.stripRestangular(b))},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.select=function(a){b.close(a)},a.closeAlert=function(b){a.alerts.splice(b,1)}}]),angular.module("character",["restangular"]).controller("CharacterDetail",["$scope","$stateParams","Restangular","$state","$localStorage",function(a,b,c,d,e){a.endpoint=c.one("characters",b.name),a.is_me=!1,a.load_character=function(){a.endpoint.get().then(function(b){a.character=b,b.name==e.character.name&&(a.is_me=!0)})},a.load_character()}]).controller("CharacterAbilities",["$scope","$stateParams","Restangular","$state","$localStorage",function(a){a.endpoint.getList("abilities").then(function(b){a.abilities=b}),a.endpoint.getList("abilities/next").then(function(b){a.next_abilities=b}),a.use_ability=function(b){var c={ability:b.url};a.endpoint.all("use_ability").post(c).then(function(){a.load_character()},function(b){a.alert={type:"danger",msg:b.data.msg}})},a.learn_ability=function(b){var c={ability:b.url};a.endpoint.all("abilities/next").post(c).then(function(){a.abilities.push(b),a.character.ap-=b.ap_required,a.next_abilities=a.endpoint.getList("abilities/next").$object},function(b){a.alert={type:"danger",msg:b.data.msg}})},a.alert=void 0,a.close_alert=function(){a.alert=void 0}}]).controller("CharacterInventory",["$scope","$stateParams","Restangular","$state","$localStorage",function(a,b,c){a.endpoint.getList("inventory").then(function(b){a.inventory=b}),a.endpoint.one("weapon").get().then(function(b){a.eq_weapon=b,a.endpoint.getList("weapons").then(function(b){for(var c=0;c<b.length;c++)if(b[c].equipped){b.splice(c,1);break}a.weapon_records=b})}),a.endpoint.one("armor").get().then(function(b){a.eq_armor=b,a.endpoint.getList("armors").then(function(b){for(var c=0;c<b.length;c++)if(b[c].equipped){b.splice(c,1);break}a.armor_records=b})}),a.equip_weapon=function(b){var d=c.oneUrl("inventory",b.url);d.equipped=!0,d.put().then(function(b){a.weapon_records.push(a.eq_weapon);for(var c=0;c<a.weapon_records.length;c++)if(a.weapon_records[c].url==b.url){a.weapon_records.splice(c,1);break}a.eq_weapon=b,a.load_character()})},a.equip_armor=function(b){var d=c.oneUrl("inventory",b.url);d.equipped=!0,d.put().then(function(b){a.armor_records.push(a.eq_armor);for(var c=0;c<a.armor_records.length;c++)if(a.armor_records[c].url==b.url){a.armor_records.splice(c,1);break}a.eq_armor=b,a.load_character()})},a.use_item=function(b){console.log(b.item.url);var c={item:b.item.url};a.endpoint.all("use_item").post(c).then(function(c){a.character.curr_hp=c.curr_hp,b.quantity--},function(b){a.alert={type:"danger",msg:b.data.msg}})},a.alert=void 0,a.close_alert=function(){a.alert=void 0}}]),angular.module("post",["restangular"]).controller("UserPosts",["$scope","Restangular","character","inventory",function(a,b,c,d){a.character=c,a.inventory=d,a.can_post=!1,a.endpoint.one("posts").get().then(function(b){a.posts=b.results,a.next=b.next}),a.next_page=function(){b.oneUrl("next_page",a.next).get().then(function(b){for(var c=0;c<b.results.length;c++)a.posts.push(b.results[c]);a.next=b.next?b.next:void 0})}}]).controller("RelaxRoomPosts",["$scope","Restangular","$localStorage","character","inventory",function(a,b,c,d,e){a.postForm={exchanged_items:[],character:c.character.url},a.searched_items=[],a.alerts=[],a.can_post=!0,a.character=d,a.inventory=e;var f=1,g=1;a.closeAlert=function(b){a.alerts.splice(b,1)},a.plus_given=function(){f++,a.postForm.exchanged_items.push({given:!0})},a.plus_received=function(){g++,a.postForm.exchanged_items.push({given:!1})};var h={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,ESC:27};a.keypressed=function(b,c){var d=b.which;d==h.LEFT||d==h.RIGHT||d==h.UP||d==h.DOWN||a.search(a.postForm.exchanged_items[c].item_name)},a.search=function(c){c&&b.all("items").customGET("",{query:c}).then(function(c){var d=b.stripRestangular(c);a.searched_items=d})},a.select_given_item=function(b,c,d,e){a.postForm.exchanged_items[e].item=b.item},a.select_received_item=function(b,c,d,e){a.postForm.exchanged_items[e].item=b},a.post=function(){var b=a.postForm;if(b.give_guils&&isNaN(b.give_guils))return void a.alerts.push({type:"danger",msg:"Given guils must be a number!"});if(b.receive_guils&&isNaN(b.receive_guils))return void a.alerts.push({type:"danger",msg:"Received guils must be a number!"});for(var d=0;d<b.exchanged_items.length;d++){var e=b.exchanged_items[d];if(e.quantity&&isNaN(e.quantity))return void a.alerts.push({type:"danger",msg:"Quantity must be a number!"})}b.exchanged_items=b.exchanged_items.filter(function(a){return a.item?!0:!1}),b.exchanged_items=b.exchanged_items.map(function(a){return a.item=a.item.url,a.quantity||delete a.quantity,a}),a.endpoint.all("posts").post(b).then(function(b){a.posts.unshift(b),a.postForm={exchanged_items:[],character:c.character.url}},function(b){a.postForm={exchanged_items:[],character:c.character.url},a.alerts.push({type:"danger",msg:b.data})})},a.endpoint.one("posts").get().then(function(b){a.posts=b.results,a.next=b.next}),a.next_page=function(){b.oneUrl("next_page",a.next).get().then(function(b){for(var c=0;c<b.results.length;c++)a.posts.push(b.results[c]);a.next=b.next?b.next:void 0})}}]).controller("Post",["$scope","Restangular","$state","$stateParams",function(a,b,c,d){var e=a.character,f=a.inventory;a.comment={},a.searched_items=[],a.alerts=[],a.showing=!1,a.editing=!1,a.next=void 0,a.editPost=a.post,a.closeAlert=function(b){a.alerts.splice(b,1)};var g=1,h=1;a.closeAlert=function(b){a.alerts.splice(b,1)},a.plus_given=function(){g++,a.editPost.exchanged_items.push({given:!0})},a.plus_received=function(){h++,a.editPost.exchanged_items.push({given:!1})};var i=function(b){if(0===b.exchanged_items.length)return a.not_acceptable_why="No exchange",!1;if(!b.opened)return a.not_acceptable_why="Closed",!1;if(b.character==e.url)return a.not_acceptable_why="Post of yours",!1;if(b.receive_guils>e.guils)return a.not_acceptable_why="Not enough guils",!1;exchanges=b.exchanged_items;for(var c=!1,d=0;d<exchanges.length;d++){var g=exchanges[d];if(!g.given){for(var h=0;h<f.length;h++){var i=f[h];if(i.item.url==g.item.url&&i.quantity<g.quantity)return a.not_acceptable_why="Not enough "+g.item.name,!1;i.item.url==g.item.url&&i.quantity>=g.quantity&&(c=!0)}if(!c)return a.not_acceptable_why="Missing item(s)",!1;c=!1}}return!0};a.acceptable=i(a.post),a.toggle_editing=function(){a.editPost=b.oneUrl("post",a.post.url).get().$object,a.editing=!a.editing};var j={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,ESC:27};a.keypressed=function(b,c){var d=b.which;d==j.LEFT||d==j.RIGHT||d==j.UP||d==j.DOWN||a.search(a.editPost.exchanged_items[c].item.name)},a.search=function(c){c&&b.all("items").customGET("",{query:c}).then(function(c){var d=b.stripRestangular(c);a.searched_items=d})},a.select_received_item=function(b,c,d,e){a.editPost.exchanged_items[e].item=b},a.select_given_item=function(b,c,d,e){a.editPost.exchanged_items[e].item=b.item},a.delete_post=function(){var c=a.post.url;b.oneUrl("post",c).remove().then(function(){for(var b=0;b<a.posts.length;b++)a.posts[b].url==c&&a.posts.splice(b,1)})},a.edit_post=function(){var c=a.editPost;if(c.give_guils&&isNaN(c.give_guils))return void a.alerts.push({type:"danger",msg:"Given guils must be a number!"});if(c.receive_guils&&isNaN(c.receive_guils))return void a.alerts.push({type:"danger",msg:"Received guils must be a number!"});for(var d=0;d<c.exchanged_items.length;d++){var e=c.exchanged_items[d];if(e.quantity&&isNaN(e.quantity))return void a.alerts.push({type:"danger",msg:"Quantity must be a number!"})}c.exchanged_items=c.exchanged_items.filter(function(a){return a.item?!0:!1}),c.exchanged_items=c.exchanged_items.filter(function(a){return a.item.name.length>0}).map(function(a){return a.item=a.item.url,a.quantity||delete a.quantity,a}),b.oneUrl("post",c.url).customPUT(c).then(function(c){a.post=b.stripRestangular(c),a.editPost=a.post,a.toggle_editing()},function(c){console.log(c),a.editPost=b.oneUrl("post",a.post.url).get().$object,a.alerts.push({type:"danger",msg:c.data})})},a.accept=function(){b.oneUrl("post",a.post.url).all("accept").post({character:a.character.url}).then(function(e){a.post=b.stripRestangular(e),a.acceptable=!1,c.transitionTo(c.current,d,{reload:!0,inherit:!1,notify:!0}),a.alerts.push({type:"success",msg:"Successfully accepted"})},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.load_comments=function(){b.oneUrl("post",a.post.url).one("comments").get().then(function(b){a.comments=b.results,a.showing=!0,a.next=b.next})},a.remove_comments=function(){a.comments={},a.showing=!1},a.submit=function(){b.oneUrl("post",a.post.url).all("comments").post(a.comment).then(function(b){a.comment={},a.showing&&a.comments.unshift(b)},function(a){console.log(a)})},a.next_page=function(){b.oneUrl("next_page",a.next).get().then(function(b){for(var c=0;c<b.results.length;c++)a.comments.push(b.results[c]);a.next=b.next?b.next:void 0})}}]).controller("Comment",["$scope","Restangular",function(a,b){a.editing=!1,a.editComment={content:a.comment.content},a.toggle_editing=function(){a.editing=!a.editing},a.delete_comment=function(){var c=a.comment.url;b.oneUrl("comment",c).remove().then(function(){if(a.showing)for(var b=0;b<a.comments.length;b++)a.comments[b].url==c&&a.comments.splice(b,1)})},a.edit_comment=function(){var c=b.oneUrl("comments",a.comment.url);console.log(c),c.content=a.editComment.content,c.put().then(function(){a.comment.content=c.content,a.toggle_editing()})}}]),angular.module("room",["luegg.directives"]).controller("Rooms",["$scope","$state","$localStorage","Restangular",function(a,b,c,d){a.pverooms=d.all("rooms/pve").getList().$object,a.relaxrooms=d.all("rooms/relax").getList().$object}]).controller("PVERoom",["$scope","Restangular","$stateParams","$localStorage","$modal","Facebook","SpawnService","MobService","CharacterService","FBStoriesService","character","character_abilities","weapons","armors","items","mobs","room","$timeout","$state","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){if(k.curr_hp<=0){e.open({templateUrl:"deadModal.html",controller:"DeadModal",backdrop:"static",keyboard:!1,resolve:{character:function(){return k.name}}})}var u=[5,10].map(function(a){return 1e3*a}),v=!1;a.messages=[],a.fighting=!1,a.action="ABILITY",a.abilityForm={},a.itemForm={},a.target=void 0,a.character=k,a.abilities=l,a.weapons=m,a.armors=n,a.armors=n,a.items=o,a.room=q;var w;a.$on("$destroy",function(){g.stop(),console.info("spawn stopped")}),t.$on("$stateChangeStart",function(a,b,c){if(w){a.preventDefault();var d=e.open({templateUrl:"flightModal.html",controller:"FlightModal"});d.result.then(function(a){a||(console.info("mob stopped"),r.cancel(w),w=void 0,s.go(b,c))})}});var x=function(b,c,d,e){var f={attacked:c,attacker:b,ability:d,dmg:e,from_mob:!0};a.messages.push(f)},y=function(b,c,d,e){var f={attacked:c,attacker:b,ability:d,dmg:e,from_character:!0};a.messages.push(f)},z=function(b){var c={content:b,info:!0};a.messages.push(c)},A=function(b){for(var c=0;c<a.items.length;c++)if(b==a.items[c].item.name)return a.items[c];return void 0},B=function(b){for(var c=0;c<a.abilities.length;c++)if(b==a.abilities[c].name)return a.abilities[c];return void 0};a.toggle_action=function(){a.action="ABILITY"==a.action?"ITEM":"ABILITY"},a.filter_mob_msg=function(a){return console.log(a),a.from_mob?!1:!0},a.filter_character_msg=function(a){return console.log(a),a.from_character?!1:!0},a.swap_target=function(){a.target=a.target==a.mob?a.character:a.mob},a.equip=function(a,c){if(!a.equipped){var d=b.oneUrl("inventory",a.url);d.equipped=!0,d.put().then(function(){var b=n;c&&(b=m);for(var d=0;d<b.length;d++)b[d].equipped&&(b[d].equipped=!1);a.equipped=!0})}};var C=function(){return g.spawn(p).then(function(c){var d=e.open({templateUrl:"spawnModal.html",controller:"SpawnModal",backdrop:"static",keyboard:!1,resolve:{room:function(){return a.room.name},mob:function(){return c.name}}});d.result.then(function(){a.mob=c,b.one("mobs",c.slug).getList("abilities").then(function(d){var e=b.stripRestangular(d);a.fighting=!0,a.target=c,w=D(e,0)})})},function(b){console.log(a.room.name+": "+b)})},D=function(b,c){if(0!==a.mob.curr_hp&&F()){var d=Math.floor(u[0]+Math.random()*(u[1]-u[0]))+c;return r(function(){h.attack(a.mob.slug,a.character.url,b).then(function(c){c.attack.then(function(d){var e=a.character.name,f=d.dmg,g=d.attacked_hp;return"H"==d.ability.element?(e=a.mob.name,g=a.mob.curr_hp-f,g>a.mob.max_hp&&(g=a.mob.max_hp)):a.character.curr_hp=g,x(a.mob.name,e,d.ability.name,d.dmg),F()?void(w=D(b,c.ct)):void E(!1)})})},d,!0)}},E=function(c){if(a.fighting)if(w&&(console.info("mob stopped"),r.cancel(w),w=void 0),a.fighting=!1,z("Battle ended"),c)b.oneUrl("character",k.url).all("end_battle").post({mob:a.mob.url}).then(function(c){var f=e.open({templateUrl:"winModal.html",controller:"WinModal",resolve:{character:function(){return a.character},mob:function(){return a.mob},room:function(){return a.room},end:function(){return c}}});f.result.then(function(){a.weapons=b.one("characters",d.character.name).getList("weapons").$object,a.armors=b.one("characters",d.character.name).getList("armors").$object,a.items=b.one("characters",d.character.name).getList("items").$object,b.one("characters",d.character.name).get().then(function(c){a.character=b.stripRestangular(c),F()&&C()})})}),j.defeat(a.character.fb_id,a.room.fb_id,a.mob.fb_id);else{j.lose(a.character.fb_id,a.room.fb_id,a.mob.fb_id);{e.open({templateUrl:"loseModal.html",controller:"LoseModal",backdrop:"static",keyboard:!1,resolve:{character:function(){return a.character},room:function(){return a.room},mob:function(){return a.mob}}})}}},F=function(){return a.character.curr_hp>0},G=100,H=4;a.max=G,a.progr=0;var I=function(b){if(console.log("CT "+b),v=!0,1500>b)return a.progr=G,void r(function(){a.progr=0,v=!1},1500,!0);var c=(b-500)/H,d=function(b,c){return c>H+1?(a.progr=0,void(v=!1)):void r(function(){a.progr=G*(c/H)},b,!0).then(function(){d(b,c+1)})};d(c,1)};a.attack=function(){if(!v){var b=a.target.url,c=B(a.abilityForm.ability);return a.abilityForm={},c?void i.attack(a.character,b,c).then(function(b){var c=b.ct;I(c),b.attack.then(function(b){var c=b.dmg,d=b.ability,e=b.attacked_hp,f=b.attacker_mp;e||(e=a.target.curr_hp-c,0>e&&(e=0)),a.target.curr_hp=e,a.character.curr_mp=f,y(a.character.name,a.target.name,d.name,c),0===a.mob.curr_hp&&E(!0),0===a.character.curr_hp&&E(!1)})},function(a){console.log(a),z(a.data.msg)}):void z("Ability not found")}},a.use_item=function(){var b=A(a.itemForm.item);return a.itemForm={},b?void i.use_item(a.character.name,b.item).then(function(c){a.character.curr_hp=c.curr_hp,b.quantity-=1},function(a){z(a.data.msg)}):void z("Item not found")},F()&&C()}]).controller("SpawnModal",["$scope","$modalInstance","room","mob",function(a,b,c,d){a.room=c,a.mob=d,a.start_fight=function(){b.close()}}]).controller("WinModal",["$scope","$modalInstance","$localStorage","Facebook","FBStoriesService","Restangular","character","room","mob","end",function(a,b,c,d,e,f,g,h,i,j){a.mob=i.name,a.end=j,a.alerts=[],a.tweet_text="Won a battle against "+i.name,a.share=function(){console.log("share"),angular.element("#share-fb-button").addClass("disabled");d.getLoginStatus(function(b){a.$apply(function(){if("connected"==b.status){var j={access_token:b.authResponse.accessToken};f.all("sa/associate/").customGET("facebook",j).then(function(b){c.user=b.username,c.facebook=!0;var f={character:g.fb_id,room:h.fb_id,mob:i.fb_id};d.ui({method:"share_open_graph",action_type:e.APP_NAMESPACE+":defeat",action_properties:JSON.stringify(f)},function(b){!b||b.error?a.alerts.push({type:"danger",msg:b.error}):(a.alerts.push({type:"success",msg:"Succesfully posted to your timeline"}),console.log(b))})},function(a){console.log(a)})}else"not_authorized"===b.status?console.log(b):d.login(function(b){b.authResponse&&a.share()},{scope:"publish_actions"})})})},a.closeAlert=function(b){a.alerts.splice(b,1)},a.close=function(){b.close()}}]).controller("LoseModal",["$scope","$modalInstance","$state","$localStorage","Facebook","FBStoriesService","Restangular","character","room","mob",function(a,b,c,d,e,f,g,h,i,j){a.mob=j.name,a.alerts=[];var k=function(){c.go("character.inventory",{name:d.character.name})};a.tweet_text="Lose a battle against "+j.name,a.share=function(){console.log("share"),angular.element("#share-fb-button").addClass("disabled");e.getLoginStatus(function(b){a.$apply(function(){if("connected"==b.status){var c={access_token:b.authResponse.accessToken};g.all("sa/associate/").customGET("facebook",c).then(function(b){d.user=b.username,d.facebook=!0;var c={character:h.fb_id,room:i.fb_id,mob:j.fb_id};e.ui({method:"share_open_graph",action_type:f.APP_NAMESPACE+":lose_against",action_properties:JSON.stringify(c)},function(b){!b||b.error?a.alerts.push({type:"danger",msg:b.error}):(a.alerts.push({type:"success",msg:"Succesfully posted to your timeline"}),console.log(b))})},function(a){console.log(a)})}else"not_authorized"===b.status||e.login(function(b){b.authResponse&&a.share()},{scope:"publish_actions"})})})},a.closeAlert=function(b){a.alerts.splice(b,1)},a.close=function(){b.close(),k()}}]).controller("FlightModal",["$scope","$modalInstance",function(a,b){a.flight=function(){b.close(!1)},a.close=function(){b.close(!0)}}]).controller("DeadModal",["$scope","$modalInstance","$state","FBStoriesService","character",function(a,b,c,d,e){a.close=function(){b.close(),c.go("character.inventory",{name:e})
}}]).controller("RelaxRoom",["$scope","Restangular","$state","$stateParams","$localStorage","$modal","Facebook","FBStoriesService","character","room","inventory","buy_items",function(a,b,c,d,e,f,g,h,i,j,k,l){a.endpoint=b.one("rooms/relax",d.room_name),a.character_endpoint=b.one("characters",e.character.name),a.init_msg="Welcome, I am the merchant at "+d.room_name,a.sell_items=k,a.buy_items=l,a.character=i,a.msgForm={},a.action="BUY",a.toggle_action=function(){a.action="BUY"==a.action?"SELL":"BUY",m.reset()};var m={find_item:function(b){var c;if("BUY"==a.action){for(c=0;c<l.length;c++)if(b==l[c].name)return l[c];return void 0}if("SELL"==a.action){for(c=0;c<a.sell_items.length;c++)if(b==a.sell_items[c].item.name)return a.sell_items[c].item;return void 0}},reset:function(){var b={content:"Please type the item you want to "+a.action,from_merchant:!0};a.messages.push(b),a.state=m.INIT},INIT:function(b){item=m.find_item(b);var c;if(item)a.selected_item=item,c={content:"So you want to "+a.action+" "+b+"... How many?",from_merchant:!0},a.messages.push(c),a.state=m.HOW_MANY;else{var d="";d="BUY"==a.action?"I do not sell "+b+", sorry...":"You do not have "+b+" in your inventory",c={content:d,info:!0},a.messages.push(c)}},HOW_MANY:function(b){var c;if(isNaN(b))c={content:"Please give me a valid number",info:!0},a.messages.push(c);else{c={content:"So you want to "+a.action+" "+b+" of "+a.selected_item.name,from_merchant:!0},a.messages.push(c);var d={item:a.selected_item.url,quantity:b,operation:a.action[0]};a.character_endpoint.all("transactions").post(d).then(function(a){m.OK(a)},function(a){console.log(a),m.KO(a)})}},OK:function(b){var c={content:"Well done",from_merchant:!0};a.character.guils=b.guils_left,a.messages.push(c),a.transaction_ended(c.content),a.sell_items=a.character_endpoint.getList("inventory").$object},KO:function(b){var c={content:b.data.msg,from_merchant:!0};a.messages.push(c),m.reset()}};a.endpoint.get().then(function(b){var c={content:"Welcome, I am the merchant at "+b.name,from_merchant:!0};a.messages=[c],m.reset()}),a.ai=m,a.state=m.INIT,a.send=function(){var b=a.msgForm.content,c={content:b,from_user:!0};a.messages.push(c),a.state(b),a.msgForm={}},a.put_item=function(b){a.msgForm.content=b},a.transaction_ended=function(){"BUY"==a.action?h.buy(i.fb_id,j.fb_id,a.selected_item.fb_id):h.sell(i.fb_id,j.fb_id,a.selected_item.fb_id);var b=f.open({templateUrl:"transactionModal.html",controller:"TransactionModal",resolve:{user:function(){return e.user},character:function(){return i},item:function(){return a.selected_item},shop:function(){return j},action:function(){return"BUY"==a.action?"bought":"sold"},fb_action:function(){return a.action.toLowerCase()}}});b.result.then(function(){m.reset(),c.transitionTo(c.current,d,{reload:!0,inherit:!1,notify:!0})})}}]).controller("TransactionModal",["$scope","$modalInstance","Restangular","$localStorage","Facebook","FBStoriesService","user","action","character","shop","item","fb_action",function(a,b,c,d,e,f,g,h,i,j,k,l){a.user=g.username,a.action=h.name,a.character=i.name,a.shop=j.name,a.item=k.name,a.alerts=[],a.share=function(){console.log("share");e.getLoginStatus(function(b){a.$apply(function(){if("connected"==b.status){var g={access_token:b.authResponse.accessToken};c.all("sa/associate/").customGET("facebook",g).then(function(b){d.user=b.username,d.facebook=!0;var c={character:i.fb_id,room:j.fb_id,loot:k.fb_id};e.ui({method:"share_open_graph",action_type:f.APP_NAMESPACE+":"+l,action_properties:JSON.stringify(c)},function(b){!b||b.error?a.alerts.push({type:"danger",msg:b.error}):(a.alerts.push({type:"success",msg:"Succesfully posted to your timeline"}),console.log(b))})},function(a){console.log(a)})}else"not_authorized"===b.status||e.login(function(b){b.authResponse&&a.share()},{scope:"publish_actions"})})})},a.tweet_text=a.user+" using "+a.character+" bought some "+a.item+" @ "+a.shop,a.closeAlert=function(b){a.alerts.splice(b,1)},a.close=function(){b.close()}}]),angular.module("search",[]).controller("Search",["$scope","Restangular","$localStorage","$state",function(a,b){{var c=b.all("users");b.all("rooms")}a.searchForm={},a.results=[];var d={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,ESC:27};a.keypressed=function(b){var c=b.which;c==d.LEFT||c==d.RIGHT||c==d.UP||c==d.DOWN||(c==d.ESC?a.submit():a.search())},a.submit=function(){a.searching=!1,a.searchForm={},a.results={}},a.search=function(){var d=a.searchForm.query;return d?void c.customGET("",{query:d}).then(function(c){var d=b.stripRestangular(c);a.results=d}):void(a.searching=!1)}}]),angular.module("user",["restangular"]).controller("UserDetail",["$scope","$stateParams","Restangular","$state","$localStorage","user",function(a,b,c,d,e,f){a.identity=f,a.endpoint=c.one("users",b.username),a.endpoint.get().then(function(b){a.user=b,b.username==f.username&&(a.isMe=!0),c.one("users",f.username).post("isfollowing",{to_user:b.url}).then(function(b){a.alreadyFollowing=b.is_following,a.fellowship=b.url},function(){a.alreadyFollowing=!1})}),a.follow=function(){data={to_user:a.user.url},c.one("users",f.username).all("following").post(data).then(function(b){console.log(b),a.alreadyFollowing=!0,a.fellowship=b.url},function(a){console.log(a)})},a.unfollow=function(){c.oneUrl("fellowships",a.fellowship).remove().then(function(){a.alreadyFollowing=!1},function(a){console.log(a)})}}]).controller("UserFollowing",["$scope","Restangular",function(a,b){a.endpoint.getList("following").then(function(c){var d=b.stripRestangular(c);d=d.map(function(a){return a.to_user}),a.followx=d})}]).controller("UserFollowers",["$scope","Restangular",function(a,b){a.endpoint.getList("followers").then(function(c){var d=b.stripRestangular(c);d=d.map(function(a){return a.from_user}),a.followx=d})}]).controller("UserCharacters",["$scope","Restangular","$localStorage",function(a,b,c){var d=a.endpoint.getList("characters").$object;a.selected_character=c.character,a.characters=d,a.characterForm={},a.alerts=[],a.select=function(b){c.character=b,a.selected_character=b},a.is_selected=function(b){return b.name==a.selected_character.name},a.create_character=function(){a.endpoint.all("characters").post(a.characterForm).then(function(b){a.characters.push(b),a.alerts.push({type:"success",msg:b.name+" succesfully created!"}),a.characterForm={}},function(b){a.alerts.push({type:"danger",msg:b.data})})},a.closeAlert=function(b){a.alerts.splice(b,1)}}]);